name: CI

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04

    env:
      SIGMAUSER: ci-user

    steps:
    - uses: actions/checkout@v4

    - name: Free Disk Space (Ubuntu)
      uses: BRAINSia/free-disk-space@v2
      with:
        tool-cache: false
        mandb:   true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: false
        swap-storage: true

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libprotobuf-dev \
          libseccomp-dev \
          libspdlog-dev \
          libabsl-dev \
          libprotoc-dev \
          protobuf-compiler \
          python3-dev \
          python3-pip \
          mysql-client \
          apparmor-utils \
          parallel \
          time

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container

    # - name: Set up Python
    #   uses: actions/setup-python@v4
    #   with:
    #     python-version: '3.10'

    # - name: Install Python dependencies
    #   run: |
    #     pip install -r requirements.txt

    - name: Create dummy AWS credentials
      run: |
        mkdir -p ~/.aws
        touch ~/.aws/credentials
        touch ~/.aws/config
        # echo "[sigmaos]" >> ~/.aws/credentials
        # echo "aws_access_key_id = dummy" >> ~/.aws/credentials
        # echo "aws_secret_access_key = dummy" >> ~/.aws/credentials
        # echo "region = us-east-1" >> ~/.aws/credentials

    - name: Setup SigmaOS directories and permissions
      run: |
        sudo chmod 0666 /var/run/docker.sock

    - name: Initialize Docker Swarm and Network
      run: |
        docker swarm init
        ./create-net.sh sigmanet-testuser-$SIGMAUSER

    - name: Load AppArmor profile
      run: |
        sudo ./load-apparmor.sh

    - name: Start etcd
      run: |
        ./start-etcd.sh

    - name: Build
      run: ./build.sh

    - name: Test
      run: ./test.sh --savelogs
