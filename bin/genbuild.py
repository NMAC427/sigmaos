#!/usr/bin/env python3
import os
import subprocess
from pathlib import Path
from textwrap import indent

script_dir = Path(__file__).resolve().parent
workspace_root = script_dir / ".."

def bazel_query(*query):
    if "BUILD_WORKSPACE_DIRECTORY" in os.environ:
        exe = "bazel"
    else:
        exe = "./build.sh"

    result = subprocess.run(
        [exe, "query"] + list(query),
        check=True,
        capture_output=True,
        text=True,
        cwd=workspace_root,
    )
    return sorted(result.stdout.strip().splitlines())

def user_targets():
    return (
        bazel_query("kind('go_binary', //cmd/user/...)") +
        bazel_query("kind('cc_binary', //cpp/user/...)") +
        [
            "//rs/spawn-latency",
        ]
    )

def kernel_targets():
    return (
        bazel_query("kind('go_binary', //cmd/kernel/...)") +
        [
            "//rs/uproc-trampoline",
        ]
    )

def wasm_targets():
    return (
        bazel_query("kind('rust_shared_library', //rs/wasm/...)")
    )

def main():
    user = indent('\n'.join(f'"{t}",' for t in user_targets()), ' ' * 8)
    kernel = indent('\n'.join(f'"{t}",' for t in kernel_targets()), ' ' * 8)
    wasm = indent('\n'.join(f'"{t}",' for t in wasm_targets()), ' ' * 8)

    build_content = f"""\
# DON'T EDIT THIS BUILD FILE BY HAND
# AUTOMATICALLY GENERATED BY /bin/genbuild.py

# gazelle:ignore

load("@rules_pkg//:pkg.bzl", "pkg_tar")
load("@rules_pkg//pkg:mappings.bzl", "pkg_files", "pkg_attributes")

pkg_files(
    name = "user",
    srcs = [
{user}
    ],
    prefix = "/user",
    attributes = pkg_attributes(mode = "0755"),
)

pkg_files(
    name = "kernel",
    srcs = [
{kernel}
    ],
    prefix = "/kernel",
    attributes = pkg_attributes(mode = "0755"),
)

pkg_files(
    name = "wasm",
    srcs = [
{wasm}
    ],
    prefix = "/wasm",
    attributes = pkg_attributes(mode = "0755"),
)

pkg_files(
    name = "linux",
    srcs = [
        "//cmd/linux/bootkernel:bootkernel",
    ],
    prefix = "/linux",
    attributes = pkg_attributes(mode = "0755"),
)

pkg_files(
    name = "npproxy",
    srcs = [
        "//cmd/npproxy/npproxyd:npproxyd",
    ],
    prefix = "/npproxy",
    attributes = pkg_attributes(mode = "0755"),
)

pkg_tar(
    name = "bin",
    srcs = [
        ":user",
        ":kernel",
        ":wasm",
        ":npproxy",
        ":linux",
    ],
    package_dir = "/bin",
    stamp = 1,
    visibility = ["//bin:__pkg__"],
)
"""

    out = script_dir / "gen" / "BUILD.bazel"
    out.parent.mkdir(parents=True, exist_ok=True)
    out.write_text(build_content)

if __name__ == "__main__":
    main()
